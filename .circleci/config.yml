version: 2
jobs:
  build:
    filters:
      branches: #SET the only branches that are allowed for build
        only:
          - development
          - master
    docker:
      - image: node:6.11.2 #primary container
        environment: 
          VT_REDIS_HOST: 127.0.0.1
          VT_REDIS_PORT: 6379
      - image: redis:3.2.4 #add redis image
    environment: 
      - CODE_DEPLOY_FILENAME: 'code-deploy-bt-{{ epoch }}-bn-{{ .BuildNum }}-branch-{{ .Branch }}/Deploy_Build.zip'                  
    steps:
      - checkout

      # Install & Cache  
      # Global  
      - restore_cache: 
          keys: 
            - global-cache-1-{{ checksum ".circleci/config.yml" }}
            - global-cache-1        
      - run: 
          name: Add application dependencies
          command: |
            npm install -g bower
            curl "https://bootstrap.pypa.io/get-pip.py" -o "get-pip.py"
            python get-pip.py --user 
            ls -a ~
            echo "export PATH=~/.local/bin:$PATH" >> ~/.bash_profile
            source ~/.bash_profile
            pip --version
      - save_cache: 
          key: global-cache-1-{{ checksum ".circleci/config.yml" }}
          paths: 
            - /usr/local/lib/node_modules
            - /usr/local/bin

      # Install & Cache             
      # NPM vendors
      - restore_cache: 
          keys: 
            - npm-cache-1-{{ checksum "package.json" }}
            - npm-cache-1       
      - run: 
          name: Install Node
          command: |
            npm install     
      - save_cache: 
          key: npm-cache-1-{{ checksum "package.json" }}
          paths: 
            - node_modules

      # Install & Cache 
      # bower vendors            
      - restore_cache: 
          keys: 
            - bower-cache-1-{{ checksum "bower.json" }}
            - bower-cache         
      - run: 
          name: Install Bower
          command: |
            bower install    
      - save_cache: 
          key: bower-cache-1-{{ checksum "bower.json" }}
          paths: 
            - public/bower_components
      - run: 
          name: Test
          command: npm test   
      - run: 
          name: Code Deploy - package
          command: |
            aws --version
            aws deploy push \
              --application-name video-interview-POC-Deploy \
              --s3-location s3://{{ .Environment.AWS_CODE_DEPLOY_S3_BUCKET }}/{{ .Environment.CODE_DEPLOY_FILENAME }} --ignore-hidden-files