version: 2
jobs:
  build:
    filters:
      branches: #SET the only branches that are allowed for build
        only:
          - development  
          - master
    docker:
      - image: node:6.11.2 #primary container
        environment: 
          VT_REDIS_HOST: 127.0.0.1
          VT_REDIS_PORT: 6379
      - image: redis:3.2.4 #add redis image
    steps:
      - checkout

      # Install & Cache  
      # Global  
      - restore_cache: 
          keys: 
            - global-cache-1-{{ checksum ".circleci/config.yml" }}
            - global-cache-1        
      - run: 
          name: Add application dependencies
          command: |
            npm install -g bower
      - save_cache: 
          key: global-cache-1-{{ checksum ".circleci/config.yml" }}
          paths: 
            - /usr/local/lib/node_modules
            - /usr/local/bin

      # Install & Cache             
      # NPM vendors
      - restore_cache: 
          keys: 
            - npm-cache-1-{{ checksum "package.json" }}
            - npm-cache-1       
      - run: 
          name: Install Node
          command: |
            npm install     
      - save_cache: 
          key: npm-cache-1-{{ checksum "package.json" }}
          paths: 
            - node_modules

      # Install & Cache 
      # bower vendors            
      - restore_cache: 
          keys: 
            - bower-cache-1-{{ checksum "bower.json" }}
            - bower-cache         
      - run: 
          name: Install Bower
          command: |
            bower install    
      - save_cache: 
          key: bower-cache-1-{{ checksum "bower.json" }}
          paths: 
            - public/bower_components
      - run: 
          name: Test
          command: npm test   

      # - store_artifacts: 
      #     path: test-results.xml
      #     prefix: tests
      # - store_test_results:
      #     path: test-results.xml

  # test: 
  #   docker:
  #     - image: node:6.11.2 #primary container
  #       environment: 
  #         VT_REDIS_HOST: 127.0.0.1
  #         VT_REDIS_PORT: 6379
  #     - image: redis:3.2.4 #add redis image     
  #   steps: 
  #     - checkout
  #     - run: 
  #         name: Test
  #         command: npm test
  #     - store_artifacts: 
  #         path: test-results.xml
  #         prefix: tests
  #     - store_test_results:
  #         path: test-results.xml

# #ADD workflow      
# workflows: 
#   version: 2
#   build_and_test: 
#     jobs: 
#       - build
#       - test: 
#           requires: 
#             - build 
#           filters:
#             branches: #SET the only branches that are allowed for build
#               only:
#                 - development