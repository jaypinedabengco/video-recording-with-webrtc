version: 2
jobs:
  build:
    docker:
      - image: node:6.11.2
        environment: 
          VT_REDIS_HOST: 127.0.0.1
          VT_REDIS_PORT: 6379
      - image: redis:3.2.4
    steps:
      - checkout
      - run: 
          name: Add application dependencies
          command: |
            npm install -g bower
            npm install pm2 -g 

      # Install & Cache 
      # NPM vendors
      - restore_cache: 
          keys: 
            - npm-cache-1-{{ checksum "package.json" }}
            - npm-cache-1       
      - run: 
          name: Install Node
          command: |
            npm install     
      - save_cache: 
          key: npm-cache-1-{{ checksum "package.json" }}
          paths: 
            - node_modules

      # Install & Cache 
      # bower vendors            
      - restore_cache: 
          keys: 
            - bower-cache-1-{{ checksum "bower.json" }}
            - bower-cache         
      - run: 
          name: Install Bower
          command: |
            bower install    
      - save_cache: 
          key: bower-cache-1-{{ checksum "bower.json" }}
          paths: 
            - public/bower_components

      # Start the Application
      - run:
          name: Start Application
          command: | 
            pm2 start bin/www  --name "webrtc-app" 

      # Check Health
      - run: 
          name: Check Health
          command: |
            curl --connect-timeout 2.37 --max-time 5.00 http://127.0.0.1:8081/api/healthcheck